{"version":3,"file":"load.js","sources":["../src/load.js"],"sourcesContent":["import createCache from \"@uppercod/cache\";\nimport { compile } from \"stylis\";\nimport createTree from \"@uppercod/imported\";\n\nconst cache = createCache();\n\n/**\n * Create a queue of plugins that access a root object,\n * this object allows you to declare one read per file\n * and share cache between readings\n * @param {root} data\n * @param {plugin[]} plugins\n * @param {parallel} [parallel]\n * @returns {Promise<root>}\n */\nexport function load(data, plugins = [], parallel = {}) {\n    if (!data.tree) {\n        data.tree = createTree();\n        data.tree.add(data.file);\n        data.rootFile = data.file;\n    }\n    return (parallel[data.file] =\n        parallel[data.file] || map(data, plugins, parallel));\n}\n/**\n *\n * @param {root} data\n * @param {plugin[]} plugins\n * @param {parallel} parallel\n */\nfunction map(data, plugins, parallel) {\n    /**\n     * Root is only for local use to keep the mutations\n     * associated with a root node.\n     */\n    const [root] = cache(compile, `@root{${data.code}}`);\n    /**\n     * Create root access to keep the mutation on the root,\n     * This node is the only one without parent and root\n     */\n    if (!data.root) data.root = root;\n    /**\n     * An asynchronous pipe is generated, parallel processes\n     * are only allowed from a plugin.\n     * In this way the mutation can be controlled without\n     * problems by collision of parallel references\n     */\n    return plugins\n        .reduce(\n            (pipe, plugin) =>\n                pipe.then(async () => {\n                    /**\n                     * The context allows inheriting the main data\n                     * and associate a root dependency through data.tree\n                     * @type {context}\n                     **/\n                    const context = {\n                        load: (nextData) => {\n                            data.tree.addChild(data.file, nextData.file);\n                            return load(\n                                { ...data, ...nextData },\n                                [plugin],\n                                parallel\n                            ).then(({ css }) => css);\n                        },\n                    };\n                    await plugin({ ...data, css: root.children }, context);\n                }),\n            Promise.resolve()\n        )\n        .then(() => ({\n            ...data,\n            // the css is a reference from root.children\n            css: root.children,\n        }));\n}\n\n/**\n * @typedef {{[src:string]:Promise<root>}} parallel\n */\n\n/**\n * @typedef {import(\"stylis\").Element} css\n */\n\n/**\n * @typedef {Object} root\n * @property {string} file\n * @property {string} code\n * @property {css[]} [css]\n * @property {string} [rootFile]\n * @property {css} [root]\n * @property {import(\"@uppercod/imported\").Context} [tree]\n */\n\n/**\n * @typedef {(root:root)=>Promise<css[]>} subLoad\n */\n\n/**\n * @typedef {(root:root,context:context)=>Promise<void>|null} plugin\n */\n\n/**\n * @typedef {Object} context\n * @property {subLoad} load\n */\n"],"names":["createCache","createTree","compile"],"mappings":";;;;;;;;;;;;;AAIA,MAAM,KAAK,GAAGA,+BAAW,EAAE,CAAC;AAC5B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAAS,IAAI,CAAC,IAAI,EAAE,OAAO,GAAG,EAAE,EAAE,QAAQ,GAAG,EAAE,EAAE;AACxD,IAAI,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE;AACpB,QAAQ,IAAI,CAAC,IAAI,GAAGC,8BAAU,EAAE,CAAC;AACjC,QAAQ,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;AACjC,QAAQ,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC;AAClC,KAAK;AACL,IAAI,QAAQ,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC;AAC/B,QAAQ,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,GAAG,CAAC,IAAI,EAAE,OAAO,EAAE,QAAQ,CAAC,EAAE;AAC7D,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA,SAAS,GAAG,CAAC,IAAI,EAAE,OAAO,EAAE,QAAQ,EAAE;AACtC;AACA;AACA;AACA;AACA,IAAI,MAAM,CAAC,IAAI,CAAC,GAAG,KAAK,CAACC,cAAO,EAAE,CAAC,MAAM,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC;AACzD;AACA;AACA;AACA;AACA,IAAI,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC;AACrC;AACA;AACA;AACA;AACA;AACA;AACA,IAAI,OAAO,OAAO;AAClB,SAAS,MAAM;AACf,YAAY,CAAC,IAAI,EAAE,MAAM;AACzB,gBAAgB,IAAI,CAAC,IAAI,CAAC,YAAY;AACtC;AACA;AACA;AACA;AACA;AACA,oBAAoB,MAAM,OAAO,GAAG;AACpC,wBAAwB,IAAI,EAAE,CAAC,QAAQ,KAAK;AAC5C,4BAA4B,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,EAAE,QAAQ,CAAC,IAAI,CAAC,CAAC;AACzE,4BAA4B,OAAO,IAAI;AACvC,gCAAgC,EAAE,GAAG,IAAI,EAAE,GAAG,QAAQ,EAAE;AACxD,gCAAgC,CAAC,MAAM,CAAC;AACxC,gCAAgC,QAAQ;AACxC,6BAA6B,CAAC,IAAI,CAAC,CAAC,EAAE,GAAG,EAAE,KAAK,GAAG,CAAC,CAAC;AACrD,yBAAyB;AACzB,qBAAqB,CAAC;AACtB,oBAAoB,MAAM,MAAM,CAAC,EAAE,GAAG,IAAI,EAAE,GAAG,EAAE,IAAI,CAAC,QAAQ,EAAE,EAAE,OAAO,CAAC,CAAC;AAC3E,iBAAiB,CAAC;AAClB,YAAY,OAAO,CAAC,OAAO,EAAE;AAC7B,SAAS;AACT,SAAS,IAAI,CAAC,OAAO;AACrB,YAAY,GAAG,IAAI;AACnB;AACA,YAAY,GAAG,EAAE,IAAI,CAAC,QAAQ;AAC9B,SAAS,CAAC,CAAC,CAAC;AACZ,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;"}